apiVersion: v1
kind: ConfigMap
metadata:
  name: caller-agent-config
  namespace: workloads
data:
  nginx.conf: |
    events {
      worker_connections 1024;
    }
    http {
      server {
        listen 8080;

        # Health check
        location /health {
          return 200 '{"status":"healthy","agent":"caller-agent"}';
          add_header Content-Type application/json;
        }

        # Direct response (no downstream call)
        location / {
          return 200 '{"status":"ok","agent":"caller-agent","message":"Hello from caller-agent"}';
          add_header Content-Type application/json;
        }

        # Call through egress to external resource
        location /call-external {
          proxy_pass http://envoy-egress.egress-gateway.svc.cluster.local/external/get;
          proxy_set_header Host httpbin.org;
          proxy_set_header X-Agent-Id caller-agent;
          proxy_set_header X-Trust-Hop 2;
          # Forward trust headers
          proxy_pass_request_headers on;
        }

        # Call another agent (chain demo)
        location /call-agent {
          proxy_pass http://agent.workloads.svc.cluster.local/;
          proxy_set_header X-Agent-Id caller-agent;
          proxy_set_header X-Trust-Hop 2;
          proxy_pass_request_headers on;
        }
      }
    }
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: caller-agent
  namespace: workloads
  labels:
    app: caller-agent
spec:
  replicas: 1
  selector:
    matchLabels:
      app: caller-agent
  template:
    metadata:
      labels:
        app: caller-agent
    spec:
      containers:
        - name: caller-agent
          image: nginx:1.25-alpine
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: config
              mountPath: /etc/nginx/nginx.conf
              subPath: nginx.conf
          resources:
            requests:
              memory: "32Mi"
              cpu: "10m"
            limits:
              memory: "64Mi"
              cpu: "100m"
      volumes:
        - name: config
          configMap:
            name: caller-agent-config
---
apiVersion: v1
kind: Service
metadata:
  name: caller-agent
  namespace: workloads
spec:
  selector:
    app: caller-agent
  ports:
    - name: http
      port: 80
      targetPort: 8080
