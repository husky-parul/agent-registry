# ---
# apiVersion: v1
# kind: ConfigMap
# metadata:
#   name: envoy-ingress-config
#   namespace: ingress-gateway
# data:
#   envoy.yaml: |
#     static_resources:
#       listeners:
#         - name: ingress_listener
#           address:
#             socket_address:
#               address: 0.0.0.0
#               port_value: 8080
#           filter_chains:
#             - filters:
#                 - name: envoy.filters.network.http_connection_manager
#                   typed_config:
#                     "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
#                     stat_prefix: ingress_http
#                     route_config:
#                       name: local_route
#                       virtual_hosts:
#                         - name: backend
#                           domains: ["*"]
#                           routes:
#                             - match:
#                                 prefix: "/"
#                               route:
#                                 cluster: agent-service
#                     http_filters:
#                       - name: envoy.filters.http.router
#                         typed_config:
#                           "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

#       clusters:
#         - name: agent-service
#           type: STRICT_DNS
#           connect_timeout: 0.25s
#           lb_policy: ROUND_ROBIN
#           load_assignment:
#             cluster_name: agent-service
#             endpoints:
#               - lb_endpoints:
#                   - endpoint:
#                       address:
#                         socket_address:
#                           address: agent.workloads.svc.cluster.local
#                           port_value: 8080

#     admin:
#       address:
#         socket_address:
#           address: 0.0.0.0
#           port_value: 9901

# ---
apiVersion: v1
kind: Namespace
metadata:
  name: ingress-gateway
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: envoy-ingress-config
  namespace: ingress-gateway
data:
  envoy.yaml: |
    static_resources:
      listeners:
        - name: ingress_listener
          address:
            socket_address: { address: 0.0.0.0, port_value: 8080 }
          filter_chains:
            - filters:
                - name: envoy.filters.network.http_connection_manager
                  typed_config:
                    "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                    stat_prefix: ingress_http
                    # --- ADD THIS BLOCK ---
                    tracing:
                      provider:
                        name: envoy.tracers.opentelemetry
                        typed_config:
                          "@type": type.googleapis.com/envoy.config.trace.v3.OpenTelemetryConfig
                          grpc_service:
                            envoy_grpc:
                              cluster_name: otel-collector
                          service_name: ingress-gateway
                    # ----------------------
                    route_config:
                      name: local_route
                      virtual_hosts:
                        - name: backend
                          domains: ["*"]
                          routes:
                            - match: { prefix: "/" }
                              route: { cluster: agent-service }
                    http_filters:
                      - name: envoy.filters.http.router
                        typed_config:
                          "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router
      clusters:
        - name: agent-service
          type: STRICT_DNS
          connect_timeout: 0.25s
          load_assignment:
            cluster_name: agent-service
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address: { address: agent.workloads.svc.cluster.local, port_value: 8080 }
        - name: otel-collector
          type: STRICT_DNS
          connect_timeout: 0.5s
          # Envoy requires HTTP2 for OTLP gRPC
          typed_extension_protocol_options:
            envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
              "@type": type.googleapis.com
              explicit_http_config:
                http2_protocol_options: {}
          load_assignment:
            cluster_name: otel-collector
            endpoints:
              - lb_endpoints:
                  - endpoint:
                      address:
                        socket_address: { address: otel-collector.observability.svc.cluster.local, port_value: 4317 }

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: envoy-ingress
  namespace: ingress-gateway
spec:
  replicas: 1
  selector:
    matchLabels:
      app: envoy-ingress
  template:
    metadata:
      labels:
        app: envoy-ingress
    spec:
      containers:
        - name: envoy
          image: envoyproxy/envoy:v1.30-latest
          args:
            - "-c"
            - "/etc/envoy/envoy.yaml"
            - "--log-level"
            - "info"
          ports:
            - containerPort: 8080
            - containerPort: 9901
          volumeMounts:
            - name: envoy-config
              mountPath: /etc/envoy
      volumes:
        - name: envoy-config
          configMap:
            name: envoy-ingress-config
---
apiVersion: v1
kind: Service
metadata:
  name: envoy-ingress
  namespace: ingress-gateway
spec:
  type: ClusterIP
  selector:
    app: envoy-ingress
  ports:
    - name: http
      port: 8080
      targetPort: 8080
    - name: admin
      port: 9901
      targetPort: 9901
