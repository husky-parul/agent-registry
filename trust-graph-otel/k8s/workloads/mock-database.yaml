apiVersion: v1
kind: ConfigMap
metadata:
  name: mock-database-config
  namespace: workloads
data:
  server.py: |
    from http.server import HTTPServer, BaseHTTPRequestHandler
    import json

    EMPLOYEES = [
        {"id": 1, "name": "Alice", "salary": 75000},
        {"id": 2, "name": "Bob", "salary": 82000},
        {"id": 3, "name": "Charlie", "salary": 69000},
    ]

    SALES = [
        {"id": 1, "employee_id": 1, "amount": 15000, "product": "Widget Pro", "date": "2024-01-15"},
        {"id": 2, "employee_id": 1, "amount": 22000, "product": "Enterprise Suite", "date": "2024-01-20"},
        {"id": 3, "employee_id": 2, "amount": 8500, "product": "Widget Basic", "date": "2024-01-18"},
        {"id": 4, "employee_id": 2, "amount": 31000, "product": "Enterprise Suite", "date": "2024-02-01"},
        {"id": 5, "employee_id": 3, "amount": 12000, "product": "Widget Pro", "date": "2024-01-25"},
        {"id": 6, "employee_id": 3, "amount": 9500, "product": "Widget Basic", "date": "2024-02-05"},
    ]

    class Handler(BaseHTTPRequestHandler):
        def do_GET(self):
            # Log incoming headers for tracing
            print(f"[mock-database] Request: {self.path}")
            print(f"[mock-database] Headers: x-principal-id={self.headers.get('x-principal-id')}, x-agent-id={self.headers.get('x-agent-id')}")

            self.send_response(200)
            self.send_header("Content-Type", "application/json")
            self.end_headers()

            if self.path == "/employees":
                self.wfile.write(json.dumps({"employees": EMPLOYEES}).encode())
            elif self.path.startswith("/employees/"):
                emp_id = int(self.path.split("/")[-1])
                emp = next((e for e in EMPLOYEES if e["id"] == emp_id), None)
                if emp:
                    self.wfile.write(json.dumps(emp).encode())
                else:
                    self.wfile.write(json.dumps({"error": "not found"}).encode())
            elif self.path == "/sales":
                self.wfile.write(json.dumps({"sales": SALES}).encode())
            elif self.path.startswith("/sales/employee/"):
                emp_id = int(self.path.split("/")[-1])
                emp_sales = [s for s in SALES if s["employee_id"] == emp_id]
                self.wfile.write(json.dumps({"employee_id": emp_id, "sales": emp_sales}).encode())
            else:
                self.wfile.write(json.dumps({"status": "ok", "service": "mock-database"}).encode())

    HTTPServer(("0.0.0.0", 8080), Handler).serve_forever()
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mock-database
  namespace: workloads
spec:
  replicas: 1
  selector:
    matchLabels:
      app: mock-database
  template:
    metadata:
      labels:
        app: mock-database
    spec:
      containers:
        - name: mock-database
          image: python:3.11-slim
          command: ["python", "/app/server.py"]
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: config
              mountPath: /app
      volumes:
        - name: config
          configMap:
            name: mock-database-config
---
apiVersion: v1
kind: Service
metadata:
  name: mock-database
  namespace: workloads
spec:
  selector:
    app: mock-database
  ports:
    - port: 8080
      targetPort: 8080
